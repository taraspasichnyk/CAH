package com.eleks.cah.data.repository

import com.eleks.cah.data.extensions.roomOrException
import com.eleks.cah.data.model.*
import com.eleks.cah.domain.Constants.DB_REF_ANSWERS
import com.eleks.cah.domain.Constants.DB_REF_CURRENT_ROUND
import com.eleks.cah.domain.Constants.DB_REF_PLAYERS
import com.eleks.cah.domain.Constants.DB_REF_ROOMS
import com.eleks.cah.domain.Constants.DEFAULT_PLAYER_CARDS_AMOUNT
import com.eleks.cah.domain.Constants.DEFAULT_ROOM_QUESTION_CARDS
import com.eleks.cah.domain.exceptions.FailedToJoinRoomException
import com.eleks.cah.domain.model.Player
import com.eleks.cah.domain.model.RoomID
import com.eleks.cah.domain.repository.RoomsRepository
import dev.gitlive.firebase.database.DatabaseReference
import io.github.aakira.napier.Napier
import kotlinx.coroutines.flow.Flow
import kotlinx.coroutines.flow.firstOrNull
import kotlinx.coroutines.flow.map
import kotlin.random.Random

class RoomsRepositoryImpl(
    databaseReference: DatabaseReference
) : RoomsRepository {

    private val roomsDbReference = databaseReference.child(DB_REF_ROOMS)

    override suspend fun createNewRoom(hostNickname: String): GameRoomDTO {
        val inviteCode = generateInviteCode()
        var newRoom = GameRoomDTO(
            id = inviteCode,
            inviteCode = inviteCode,
            players = emptyMap(),
            questions = generateQuestionCards(),
            answers = generateAnswerCards(),
            currentRound = null
        )
        Napier.d(
            tag = TAG,
            message = "newRoom = $newRoom"
        )
        roomsDbReference.child(inviteCode).setValue(newRoom)
        val gameOwner = addPlayerToRoom(hostNickname, inviteCode, true)
        newRoom = newRoom.copy(players = mapOf(gameOwner.id to gameOwner))
        Napier.d(
            tag = TAG,
            message = "New room created, ID (inviteCode) = $inviteCode, host = $hostNickname"
        )
        return newRoom
    }

    private suspend fun generateInviteCode(): String {
        val allRoomsInviteCodes = roomsDbReference.valueEvents
            .firstOrNull()
            ?.value<HashMap<String, Unit>?>()
            ?.keys

        var newInviteCode: String = Random.nextInt(100000, 999999).toString()
        while (allRoomsInviteCodes?.contains(newInviteCode) == true) {
            newInviteCode = Random.nextInt(100000, 999999).toString()
        }
        return newInviteCode
    }

    private fun generateQuestionCards(): List<QuestionCardDTO> {
        // TODO: Generate question cards
        return listOf(
            "Я ніколи насправді не розумів програмування, доки не зіткнувся з ____ .",
            "Вітаємо! Ви були обрані для нашої літньої інтернатури. Хоча ми не можемо пропонувати зарплату, ми можемо пропонувати \"вам\" ____ .",
            "Романтичний, незабутній вечір був б неповним без ____ .",
            "Скасувати всі мої зустрічі. У нас є ситуація з ____ , яка вимагає моєї негайної уваги.",
            "Всі на землю! Ми не хочемо нікому шкодити. Ми тут лише для ____ .",
            "Нічого не каже \"Я тебе люблю\" як ____ .",
            "Той, хто контролює ____ , контролює світ.",
            "ЦРУ тепер допитує ворогів, постійно піддаючи їх ____ .",
            "Попередження Календаря Google: ____ за 10 хвилин.",
            "У новому DLC для Mass Effect Шепард повинен врятувати галактику від ____ .",
            "Друже, це дурниця. ____ .",
            "Легенда говорить про принцесу, яка дрімає вже тисячу років і може бути пробуджена лише ____ .",
            "Після відключки на Новий Рік, я прокинувся від ____ .",
            "Знаєш, хто ще любив ____ ? Гітлер.",
            "Цей додаток в основному Tinder, але для ____ .",
            "У мене строга політика. Перше побачення, вечеря. Друге, поцілунок. Третє, ____ .",
            "Наша компанія має тверду позицію щодо ____ .",
            "Замість моєї душі Диявол обіцяв мені ____ .",
            "Гроші не можуть купити мені любов, але вони можуть купити мені ____ .",
            "Цей місяць Космо: “Покращіть своє сексуальне життя за допомогою ____ у спальні”.",
            "Вона просто один з хлопців, знаєш? Вона любить пиво, футбол і ____ .",
            "Друже, ця марихуана неймовірна! Це сорт ____ .",
            "Тут, в Академії для Талановитих Дітей, ми даємо студентам можливість досліджувати ____ за своїм ритмом.",
            "Моє ім'я Ініго Монтойя. Ви вбили мого батька. Готуйтеся до ____ .",
            "Я дуже сподіваюся, що моя бабуся не попросить мене знову пояснити ____ .",
            "____ : Achievement unlocked.",
            "Я просто залишуся дома сьогодні вечеря. Ти знаєш, Нетфлікс і ____ .",
            "Благословенний ти, Господь наш Боже, творець усього світу, хто дав нам ____ .",
            "____ : Перевірено дітьми, одобрено матерями.",
            "В дитинстві, Сальвадор Далі намалював десятки картин ____ .",
            "Наші відносини строго професійні. Не заплутаймо речей ____ .",
            "Бейба, повернись до мене додому і я покажу тобі ____ .",
            "Найгірший день НА СВІТІ. #____ .",
            "Чому завершились мої останні стосунки? ____ .",
            "Я зрозумів важким шляхом, що не можна розвеселити горюючого друга ____ .",
            "Мені снився жахливий сон, батьку. Я бачив, як гори рушаться, зірки падають з неба. Я бачив ____ .",
            "Під час моєї першої гри в D&D я несподівано прикликав ____ .",
            "Мені дуже подобається ваша презентація, можете додати ще ____ ?",
            "Ніколи не шукайте в Google ____ .",
            "Астрономи виявили, що у всесвіті є 5% звичайної матерії, 25% темної матерії і 70% ____ .",
            "Я не вірю в Бога. Я вірю у ____ .",
            "Що я приніс з Івано-Франківська? ____ .",
            "Це прекрасний період мого життя. Я молодий, гарячий і повний ____ .",
            "Що за звук? ____ .",
            "Чому курка перетинала дорогу? ____ .",
            "Що могло би здатись бабусі огидним, але дивно приваблювати її? ____ .",
            "Прибирання! ____ ?",
            "Ну, бляха. Мої очі не такі добрі, але я з‘їм свій кросівок, якщо це не ____ !",
            "Що привело до зупинки оргії? ____ .",
            "Мій дідусь працював з нуля. Коли він прийшов до цієї країни, у нього було лише взуття на ногах і ____ .",
        ).mapIndexed { index, sentence ->
            val wordsList = sentence.split(" ")
            val indexOfGap = wordsList.indexOfFirst { it.contains("____") }
            QuestionCardDTO(
                id = index.toString(),
                question = sentence,
                gaps = listOf(indexOfGap)
            )
        }.sortedBy { Random.nextInt() }.take(DEFAULT_ROOM_QUESTION_CARDS)
    }

    private fun generateAnswerCards(): List<AnswerCardDTO> {
        // TODO: Generate answer cards
        return listOf(
            "100% чиста Нова Зеландія",
            "2 дівчини 1 чашка",
            "400 років колоніальних звірств",
            "50 000 вольт прямо до сосків",
            "50 мг Золофту щодня",
            "72 діви",
            "8 унцій солодкого мексиканського чорного героїну",
            "Pac-Man нестримно їсть сперму",
            "Аборти вішалки",
            "Абсолютно невиправдана впевненість",
            "Аварії на шахтах",
            "Австралія",
            "Автоканібалізм",
            "Азіати, які погано розбираються в математиці",
            "АКС спрей для тіла",
            "Активне слухання",
            "Акула!",
            "Алкоголізм",
            "Алкогольне отруєння",
            "Америка",
            "Американізація",
            "Американська мрія",
            "Американські гладіатори",
            "Аміші",
            "Ампутації на полі бою",
            "Анальні кульки",
            "Ананас з хламідіозом",
            "Англія",
            "Аперкот",
            "Ароматизовані презервативи",
            "Асиметричні цицьки",
            "Африканські діти",
            "Бабуся",
            "Багаті люди",
            "Багато кажанів",
            "Багаторізні ножові поранення",
            "Банани в піжамі",
            "Банани",
            "Банка дурниці",
            "Барабанні кола",
            "Барак Обама",
            "Бачити бабусю голою",
            "Бачити, як мій батько плаче",
            "Бджоли?",
            "Без дупи",
            "Без дурних розмов",
            "Без штанів",
            "Бездоганний анус королеви Єлизавети",
            "Безкоштовні зразки",
            "Безпорадно хихікає при згадці про хуту і тутсі",
            "Безпритульні",
            "Бенедикт Камбербетч",
            "Бензопили для рук",
            "БЕТМЕН!",
            "Бігати голим через спринклери",
            "Бідність",
            "Біла етнодержава",
            "Білий фургон",
            "Більше слонячого півня, ніж я розраховував",
            "Біоінженерні штурмові черепахи з кислотним диханням",
            "Бісексуальність",
            "Блакитна стрічка Пабста",
            "Блискучі предмети",
            "Бог",
            "Божевільний гарячий двоюрідний брат",
            "Божевільний, який живе в поліцейській будці і викрадає жінок",
            "Божевільні таблетки Сари Пейлін",
            "Бонд, Джеймс Бонд",
            "Боснійські курячі фермери",
            "Брітні Спірс у 55 років",
            "Бродячий лобок",
            "Брудні підгузки",
            "Бугери",
            "Буквальний вогняний торнадо",
            "Буквально їсть лайно",
            "Бути багатим",
            "Бути білим",
            "Бути динозавром",
            "Бути довбаним чаклуном",
            "Бути жахливим звіром, якого ніхто не міг любити",
            "Бути жінкою",
            "Бути зайнятою дорослою людиною з багатьма важливими справами",
            "Бути канадцем",
            "Бути маргіналізованим",
            "Бути неодноразовими чемпіонами світової війни!",
            "Бути розчавлений торговим автоматом",
            "Бути товстим і дурним",
            "Бути у вогні",
            "Бути чорним",
            "Бути чудовим",
            "Вагіна на смак, як підлога ванної кімнати на ОККО",
            "Вбивство наших батьків",
            "Вбивство невинних мирних жителів",
            "Вболівальники Міллволла",
            "Вдавати, що піклується",
            "Великий галас ні про що",
            "Великий льодяник",
            "Великий чорний член",
            "Величезний біцепс",
            "Веселий",
            "Веселі тварини",
            "Вечірні поперси",
            "Взаємно гарантоване знищення",
            "Взяти вівцю-жінку",
            "Вибілена дупа",
            "Вибілений мудак",
            "Вибракування борсука",
            "Вибухи",
            "Виганяти кричуще обличчя",
            "Видалені твіти Дональда Трампа",
            "Вилизувати речі, щоб вважати їх своїми",
            "Вимова назв міст північного Уельсу",
            "Випадково посковзнувся на даху",
            "Випадково пропонував секс утрьох",
            "Випий ще кугель",
            "Виривання з моря та прорив через Токіо",
            "Вирішення проблем за допомогою насильства",
            "Вирощування пари",
            "Витік кадрів моєї колоноскопії",
            "Витрачаю кровно зароблені моїми батьками гроші",
            "Витягування ям",
            "Вихователі на заміну",
            "Віддаю 110%",
            "Віддурити мою дупу",
            "Відмова від сексу, щоб грати у відеоігри",
            "Відправлення засуджених до Австралії",
            "Відпустити себе",
            "Відро риб'ячих голів",
            "Відсутнє яєчко Ленса Армстронга",
            "Відходження каменю в нирках",
            "Візки",
            "Візьміть назад",
            "Вічна дивовижність",
            "Вмирає, але чудесним чином повертається до життя",
            "Вмираючи",
            "Вміння розмовляти зі слонами",
            "Вогняні какашки",
            "Вогняні пори",
            "Волоцюги",
            "Восьминіг робить сім масок і курить сигарету",
            "Вправи з формування команди",
            "Вправи на командоутворення",
            "Впустити дитину на дно",
            "Вриваючись у пісню і танок",
            "Все ще незаймана",
            "Все, що виходить з вуст принца Філіпа",
            "Всі мої залицяльники",
            "Всі чотири зубці статевого члена єхидни",
            "Вставляю банку варення в мій анус",
            "Встановлення домінування",
            "Всюди мертві птахи",
            "Втопити дітей у ванні",
            "Вчимо робота любити",
            "Вчинення злочинів",
            "Газова антилопа",
            "Ганді",
            "Гарна чашка чаю",
            "Гаррі Поттер еротика",
            "Гарцює",
            "Гарячий безлад",
            "Гарячий сир",
            "Гарячі люди",
            "Гвалтування та грабіж",
            "Гей-конверсійна терапія",
            "Гендальф",
            "Генітальний пірсинг",
            "гермафродитні італійські картинки",
            "Героїн",
            "Герпес у роті",
            "Гетеронормативність",
            "Гладіаторські бої",
            "Глибока повага та вдячність до культури корінного населення",
            "Глобальне потепління",
            "Глорихол",
            "Гобліни",
            "Говячи ідеальну камберлендську ковбасу",
            "Голі новини",
            "Голова квадратна",
            "Головне молоко",
            "Голод",
            "Голос Моргана Фрімена",
            "Гомоеротичний волейбольний монтаж",
            "Гормональні ін'єкції",
            "Гра в дурних дурнів",
            "Гранде маккіато з соєвою карамеллю без цукру",
            "Група Дейва Метьюза",
            "Гуси",
            "Дарт Вейдер",
            "Дахи",
            "Двійники",
            "Девід Бові летить на тигрі, зробленому з блискавки",
            "Дефлорація принцеси",
            "Дженіфер Лоуренс",
            "Дивитися в дзеркало, наносити помаду і шепотіти \"сьогодні ввечері ти будеш займатися сексом з Томом Крузом\"",
            "Дивлячись на картину і кажучи \"хмммммм\"",
            "Дитячі конкурси краси",
            "Дихання пеніса",
            "Дівочий вечір у Калуші",
            "Дівчата, яким не варто впадати в дикий стан",
            "Дівчата",
            "Діджериділдо",
            "Дідова лисина",
            "Дійсно крутий капелюх",
            "Дійсно липкий Кентуккі Дурбан",
            "Дік-пік",
            "Діти з раком дупи",
            "Діти на повідку",
            "Діти, хворі на рак задниці",
            "Дічь",
            "Добрий день",
            "Добродушний, веселий австралійський расизм",
            "Дозволити сквіртувати тобі в обличчя",
            "Докладний коментар від Річі Бено",
            "Дорожня голова",
            "Дрочить у калюжу дитячих сліз",
            "Дружній вогонь",
            "Друзі з перевагами",
            "Друзі, які їдять усі ваші закуски",
            "Друзі, які їдять усі закуски",
            "Друїди",
            "Дупа тракториста",
            "Дупа як два футбольних шолома",
            "Дух моєму хлопцеві так сильно, що він гадить",
            "Едипів комплекс",
            "Екзистенціалісти",
            "Екзорцизм",
            "Екскалібур",
            "Електрика",
            "Ембріональні стовбурові клітини",
            "Емоції",
            "Ерекція, яка триває більше чотирьох годин",
            "Естроген",
            "Етнічні чистки",
            "Ефектний прес",
            "Євгеніка",
            "Жаба-гадюка",
            "Жахливі випадки лазерної епіляції",
            "Жертви серед цивільного населення",
            "Жива студійна аудиторія",
            "Життя в смітнику",
            "Жорстоке поводження з дитиною",
            "Жорстокість поліції",
            "З'їдання останнього відомого бізона",
            "З'їсти все печиво перед розпродажем випічки з вітрянкою",
            "З'явитися на оргію заради їжі",
            "З’їв занадто багато лампи",
            "Забруднити себе",
            "Забути Аламо",
            "Заздрість до пеніса",
            "Займатися сексом з кожним чоловіком у Вінніпезі",
            "Займаюся з нею сексом",
            "Закінчується сперма",
            "Залишення незручного голосового повідомлення",
            "Залізти в мішок кенгуру",
            "Замінування будинку, щоб запобігти грабіжникам",
            "Замовкни, щоб я міг дивитися гру",
            "Замовкни, щоб я міг дивитися матч",
            "Заможна людина із масажером простати",
            "Занадто гарячий суп",
            "Занедбаний Тамагочі™",
            "Запах старих",
            "Запивання та очищення",
            "Заплітання трьох пенісів у вузол",
            "Заплітання трьох пенісів у кучерявий кусок",
            "Заплітання трьох пенісів у лакричну прядку",
            "Заплутані обтяжки",
            "Заразний рак обличчя",
            "Захопити Медведчука та змусити його танцювати в костюмі мавпи",
            "Збалансований сніданок",
            "Зберегти Христа в Різдво",
            "Збір дівчат у клініці абортів",
            "Зваблення",
            "Зварене круто яйце з дупи мого чоловіка",
            "Зворотна джентрифікація",
            "Зворушливі сироти",
            "Зґвалтування на побаченні",
            "Здолати свого батька",
            "Зла людина в злому одязі",
            "Злі люди",
            "Зловісна фонова музика",
            "Змусити пеніси цілуватися",
            "Знеболювальні, що відпускаються за рецептом",
            "Зникає в небуття",
            "Знищення доказів",
            "Знімаю сорочку",
            "Знову завагітніти",
            "Зображення цицьок",
            "Золотий веселий час",
            "Золотий дощ",
            "Зробити надуте обличчя",
            "Зубні пломби",
            "Зухвала чорна жінка",
            "Зухвалий секс із задницею",
            "Зцілення вірою",
            "Їдальня з картонними вирізами акторського складу \"Друзів\",",
            "Ідіоти на своїх айфонах",
            "Їдучи на захід сонця",
            "Її Величність, Королева Єлизавета II",
            "Її Королівська Високість, Королева Єлизавета II",
            "Імпотенція",
            "Індіанські опіки",
            "Інжировий пудинг",
            "Інцест",
            "Іспанці",
            "Їсти альбіноса",
            "Їсти яйце, зварене круто з сраки мого чоловіка",
            "Їстівна білизна",
            "Їстівні підштаники",
            "Історично чорні коледжі",
            "Італійці",
            "Какання туди-сюди Назавжди",
            "Какати в суп",
            "Каммінг глибоко всередині мого найкращого брата",
            "Канада: капелюх Америки",
            "Канадський Netflix",
            "Карти проти людяності",
            "Катапульти",
            "Кашалот",
            "Кентаври",
            "Кинути люстру на своїх ворогів і піднятися по мотузці",
            "Киня",
            "Кирить тихою образою",
            "Китайський турист, який чогось дуже сильно хоче, але не може це повідомити",
            "Кіану Рівз чіпляється своєю мошонкою за гачок штор",
            "Кібернетичні вдосконалення",
            "Кім Чен Ин",
            "Кім Чен Ір",
            "Кіт з руками",
            "Кладити речі, куди вони йдуть",
            "Кладка яйця",
            "Класні відтінки",
            "Клуб дитинчат тюленів",
            "Ковдри від віспи",
            "Кози їдять банки",
            "Коказавр рекс: найрогатіший динозавр з усіх",
            "Коледж",
            "Колючка ската через груди",
            "Консервований тунець з додатковим дельфіном",
            "Консультанти",
            "Кончане підключення до Інтернету",
            "Копія приліжкового Гітлера",
            "Коричневі люди",
            "Коров'яче сказство",
            "Коротуси та притупи",
            "Кортні, Кім, Хлоя, Кендалл і Кайлі",
            "Котедж",
            "Коштовності хіп-хопу",
            "Крайня плоть",
            "Креветки, які можна з’їсти за 10 гривень",
            "Креветки, які можна з’їсти за 8 біткойнів",
            "Кредитна картка тата",
            "Кривавий фістинг",
            "Крижана мастурбація від повії з Ісландії",
            "Крихітна конячка",
            "Криховий удар",
            "Крихти по всьому закривавленому килиму",
            "Крихти по всьому клятому килиму",
            "Кричущий оргазм",
            "Кріпацтво",
            "Крішки і шматочки",
            "Кров, праця, сльози і піт",
            "Кулер, повний органів",
            "Кулька з вушної сірки, сперми та обрізків нігтів",
            "Кульки Кегеля",
            "Купів чашку для зубної щітки, яка відповідає моєму стилю життя",
            "Лава для шльопання з вишневого дерева",
            "Левеня зоопарку, що пропадає",
            "Леді, панове та ті, хто не визначився",
            "Ледь заробляю 25 000 доларів на рік",
            "Лицарство",
            "Ліберали",
            "Літаючі сексуальні змії",
            "Літаючі тарілки",
            "Літні японці",
            "Літня жінка, яка знає свій шлях у пенісі",
            "Лоботомія льодорубом",
            "Локна щелепа",
            "Лопатки для сосків",
            "Лоскот мошонки",
            "Льодяники великого розміру",
            "Любитися",
            "Люди на човні; наполовину човен, наполовину людина",
            "Люди, які відчувають запах власних шкарпеток",
            "Людський обман",
            "Лясання Найджела Фараджа знову і знову",
            "Ляснути печиво з рота сироти",
            "М'який місіонерський секс із поцілунками",
            "М'який расизм і крайня гомофобія",
            "М'ясо людини",
            "М'ячі Великі кулі Справді великі кулі",
            "Мавпа курить сигару",
            "Магніти",
            "Має анус для очей",
            "Має пеніс",
            "Майлі Сайрус у 55 років",
            "Маленька безволоса пляма на ім'я Роман",
            "Маленька весела гітара, яка називається укулеле",
            "Маленький хлопчик, який не буде мовчати про динозаврів",
            "Малювання пальчиками",
            "Мама",
            "Мастурбація",
            "Масштабна поширена посуха",
            "Математики",
            "Мати великі мрії, але немає реалістичного способу їх досягнення",
            "Махорка в спині матки",
            "Мексиканець",
            "Меми",
            "Мені час",
            "Менструальна лють",
            "Менструальне порно",
            "Мережа брехні",
            "Мертві немовлята",
            "Метання гнома",
            "Метати своє тіло з пагорба в гонитві за колесом сиру",
            "МехаГітлер",
            "Миска майонезу і людські зуби",
            "Мисливські \"випадки\"",
            "Мій батько, який помер, коли мені було сім",
            "Мій водій Uber, Павло",
            "Мій друг Дейв",
            "Мій образливий хлопець, який справді не такий уже й поганий, як тільки ти з ним познайомишся",
            "Мій перший поцілунок",
            "Мій стан стосунків",
            "Мій хороший бюстгальтер",
            "Мій чоловік-зрадник сучий син",
            "Мікропеніс",
            "Мікросвинка в крихітному плащі та чобітках",
            "Мільйони очеретяних жаб",
            "Містер Клін, прямо за вами",
            "Містер Одягайся",
            "Міцний монголоїд",
            "Мішок імбиру",
            "Мішок чарівних бобів",
            "Млин, повний трупів",
            "Моє мачете",
            "Моє потворне обличчя і погана особистість",
            "Моє сексуальне життя",
            "Мої внутрішні демони",
            "Мої горби",
            "Мої статеві органи",
            "Мої яйця на твоєму обличчі",
            "Молитва геїв",
            "Молитовний букет",
            "Моральна неоднозначність",
            "Море бід",
            "Морін із Блекпулу, найкраща читацька дружина 1988 року",
            "Моя душа",
            "Моя зрада чоловіка",
            "Моя колекція високотехнологічних секс-іграшок",
            "Моя колекція японських секс-іграшок",
            "Моя колишня дружина",
            "моя старовинна колекція капелюхів далекобійника",
            "Моя товста дочка",
            "Моя чорна дупа",
            "Моя шия, моя спина, моя киска і моя тріщина",
            "Моя яскраво-рожева дірка",
            "Мудрий терорист",
            "Музі",
            "Мультяшний верблюд насолоджується м'яким, освіжаючим смаком сигарети",
            "Мун прем'єр-міністр",
            "Мясоїдні бактерії",
            "На вас полюють, як на лисицю",
            "На жаль, цей вміст не можна переглянути у вашому регіоні",
            "Набагато молодша жінка",
            "Надзвичайно вузькі джинси",
            "Надзвичайно вузькі штани",
            "Надзвичайно хороша система охорони здоров’я",
            "Надія",
            "Надмірна компенсація",
            "Надолужити століття гноблення одним днем вибачень",
            "Наземні міни",
            "Найгірше вбивство",
            "Накриваю себе пармезаном і пластівцями чилі, тому що я піца",
            "Наліт",
            "Нанесення болю найближчим людям",
            "Напитися рідиною для полоскання рота",
            "Напівжопла прелюдія",
            "Наплювати на Третій світ",
            "Наповнюємо Шона Ханніті гелієм і спостерігаємо, як він пливе",
            "Наповнюючи свій портфель бізнес-речами",
            "Напрочуд низька кількість зґвалтувань у в'язницях",
            "Народження антихриста",
            "Насправді херня",
            "Насправді цукерки від дитини",
            "Наука",
            "Нахабство",
            "Нацисти",
            "Начинити мого сина спагетті",
            "Начос до столу",
            "Наш перший президент-шимпанзе",
            "Наш перший прем'єр-міністр-шимпанзе",
            "Не вакциную своїх дітей, тому що я дурний",
            "Не взаємний оральний секс",
            "Не прикривай рота, коли чхаєш",
            "Неакуратний секс під очима собаки",
            "Небажана вагітність",
            "Невідповідне йодлювання",
            "Невтішний день народження",
            "Невчасні жарти про Голокост",
            "Недивний висип",
            "Некрофілія",
            "Нелегальні іммігранти",
            "Нелітаючі птахи",
            "Ненависть до себе",
            "Нескінченний потік діареї",
            "Несправний презерватив",
            "нестерпно яскраві сни",
            "Нечистий рот",
            "Нещасні випадки на полюванні",
            "Низький рівень життя",
            "Ніжне погладжування внутрішньої сторони стегна",
            "Нікельбек",
            "Німецьке порно з підземелля",
            "Німці на канікулах",
            "Ніп ковзає",
            "Нічні викиди",
            "Нічого Абсолютно нічого",
            "Нічого, крім піску",
            "Новачки",
            "Новододана тактика камікадзе",
            "Ножовий злочин",
            "Нунчаки",
            "Нюхає і цілує мої ноги",
            "Нюхання клею",
            "Обійми",
            "Обман на Паралімпіаді",
            "Обмін приємностями",
            "Оголошую, що я збираюся кінчити",
            "Один грубий піздюк",
            "Один трильйон доларів",
            "Одна цицька бовтається",
            "Одні з найкращих реперів у грі",
            "Одностатеві танці на льоду",
            "Одружитися, народити дітей, зробити декілька фотографій, піти на південь Франції та померти",
            "Одружитися, народити дітей, купити щось, поїхати у Івано-Франківськ і померти",
            "Одружитися, народити кількох дітей, купити щось, піти на пенсію в Тернопіль і померти",
            "Одружитися, народити кількох дітей, купити щось, піти на пенсію на південь Франції і померти",
            "Одягатися і дивитися Nickelodeon",
            "Ожиріння",
            "Оптимус Прайм займається сексом із посудомийною машиною",
            "Орда вікінгів",
            "Основні стажисти",
            "Отримати кінчання на",
            "Отримати пальці",
            "Очікування відрижки та блювання на підлозі",
            "П'є на самоті",
            "П'ятилітровий мішок для мультфільмів",
            "Павутинний потік сперми, що вловлює світло, коли воно проходить крізь ранкове повітря",
            "Пакет халяльних закусок",
            "Пальцями",
            "Пангендерський восьминіг, який мандрує космосом у пошуках кохання",
            "Парадокс подорожі в часі",
            "Пасивна агресія",
            "Пасивно-агресивні листівки",
            "Педофіли",
            "Пеніси маленького хлопчика",
            "Пердець настільки потужний, що пробуджує велетнів від тисячолітнього сну",
            "Передарування",
            "Передній приклад",
            "Перекрут яєчка",
            "Перемінники",
            "Перехід в іслам",
            "Перстень пана Фродо",
            "Перший дзвоник",
            "Перший секс",
            "Печивний монстр пожирає євхаристійні вафлі",
            "Пити з туалету і їсти сміття",
            "Пити з туалету та їсти сміття",
            "Півкіло чистого китайського білого героїну",
            "Півнячі бої",
            "Підвищення рівня моря відповідає науковим прогнозам",
            "Підвищення рівня",
            "Підгузки-какашки",
            "Підліткова вагітність",
            "Підрив парламенту",
            "Підростки",
            "Підтримка з низів",
            "Пікантний буріто на сніданок",
            "Піксельне буккаке",
            "Пілоти-камікадзе",
            "Пінгери",
            "Піраміда з відрубаних голів",
            "План із шести пунктів, щоб зупинити човни",
            "Плем'я жінок-войовниць",
            "Плід",
            "Плутаючи відсталу людину з тим, хто просто глухий",
            "По-справжньому кайфувати",
            "Побачити, що відбувається, коли ви закриваєте людей у кімнаті з голодними чайками",
            "Поверхнева прелюдія",
            "Повна лобова оголеність",
            "Погана особиста гігієна",
            "Поганий життєвий вибір",
            "Пограбування банку сперми",
            "Пограбування могил",
            "Подвійні веселки",
            "Подивитися-побачити",
            "Подолати відчуття",
            "Позолочена вагіна Марти Стюарт",
            "Покакаю в ноутбук і закриваю його",
            "Польський народ",
            "Померлі батьки",
            "Померти від дизентерії",
            "Помістити всі свої речі в морський мішок",
            "Порада від мудрого старого чорношкірого чоловіка",
            "Порно з щупальцями",
            "Порнозірки",
            "Постійний оргазм-розлад обличчя",
            "Потаємна подряпина на задниці",
            "Потворне обличчя",
            "Потрапити в досить погану автомобільну аварію",
            "Потужна алергія",
            "Потужні стегна",
            "Потягуючи штучне попкорнове масло",
            "Пошук друзів для дорослих",
            "Пошук порно-заначки твого тата",
            "Пояснення роботи піхви",
            "Представники служби обслуговування клієнтів",
            "Презервативи зі смаком гарбузових спецій",
            "Привиди",
            "Приділіть хвилину, щоб по-справжньому зрозуміти, що Шекспір має на меті в цій сцені",
            "Прийняти такі речі",
            "Прикольні свіжі рими",
            "Примусова стерилізація",
            "Природне чоловіче посилення",
            "Природний відбір",
            "Приховування ерекції",
            "Приховування стояка",
            "Проблеми з татом",
            "Продаю дітям лід",
            "Продаю кряк дітям",
            "Пройти цілий день без мастурбації",
            "Промінь смерті",
            "Прости-малки",
            "Просто торкаюся волосся Девіда Бекхема",
            "Протез ноги Террі Фокса",
            "Протиставні великі пальці",
            "Прохідні трансвестити",
            "Прошу вибачення",
            "Прямокутники",
            "Птах, який срає людські сраки",
            "Публічне глузування",
            "Пукає і йде геть",
            "Пукнув у ваші спідниці й махнув нею на лорда Грегорі",
            "Пухлина мозку",
            "Радикальний ісламський тероризм",
            "Раптимальна повінь",
            "Раптор нападає",
            "Расистський різдвяний подарунок",
            "Рвати цю дупу, як обгортковий папір різдвяним ранком",
            "Реабілітація за рішенням суду",
            "Реабілітація",
            "Реп-музика",
            "Репресії",
            "Риба-меч",
            "Різноманітність",
            "Роби це в дупу",
            "Роби це на задниці",
            "Робити лайно в око ведмедика Падсі",
            "Робити правильно",
            "Робити це в зад",
            "Робокоп",
            "Робот поліцейський",
            "Робота",
            "Розділ Червоного моря",
            "розлад множинної особистості",
            "Розп'яття",
            "Розповідати лайнову історію, яка нікуди не приведе",
            "Розпущені коміри",
            "Розрізати грудну клітку людини та витягнути її серце, що все ще б’ється",
            "Розумний дизайн",
            "Розчулена вагіна",
            "Рухкі губи",
            "Саєнтологія",
            "Саксофонні соло",
            "Салат для чоловіків, зроблений з металу",
            "Сам страх",
            "Саме те, що ви очікували",
            "Самозаймання людини",
            "Саморобні вибухові пристрої",
            "Самоскладний посуд",
            "Санта Клаус",
            "Свербляча киска",
            "Свідки Єгови",
            "Святі матусі",
            "Свято ковбаси",
            "Секс з Патріком Стюартом",
            "Секс з тваринами",
            "Секс за згодою",
            "Секс занадто швидко після пологів",
            "Секс панди",
            "Секс-сюрприз!",
            "Секстинг",
            "Сексуальна напруга",
            "Сексуальна сечовипускання",
            "Сексуальне приниження",
            "Сексуальні бійки подушками",
            "Семеро загиблих і троє у важкому стані",
            "Сеппуку",
            "Сидіти на обличчя і говорити мені, що я сміття",
            "Сидіти на чиємусь обличчі",
            "Сидячи на моєму обличчі",
            "Сильні жіночі характери",
            "Симпатична пухнаста коала, але в неї хламідіоз",
            "Синдром подразненого кишечника",
            "Синергетичні управлінські рішення",
            "Сиропний секс з кленом",
            "Сільське господарство",
            "Скажена корова",
            "Сказати \"Я люблю тебе\"",
            "Скальпування",
            "Скелетор",
            "Скільки трави можна купити за 20 доларів",
            "Скільки трави можна купити за 20 фунтів",
            "Складання списку людей для вбивства",
            "Скоєння самогубства",
            "Скотія",
            "Скрабування під складками",
            "Слов'яни",
            "Слухати її проблеми, не намагаючись їх вирішити",
            "Смачна дупа Деніела Редкліффа",
            "Смачна цицька",
            "Смертельна гонка на візках",
            "Смокчу члени, щоб не потрапити в призов",
            "Сокіл з шапкою на голові",
            "СОКІЛЬНИЙ УДАР!!!",
            "Соло на саксофоні",
            "Солодка, солодка помста",
            "Солоний сюрприз",
            "Сомалійські пірати",
            "Сонечко і веселка",
            "Соплі",
            "Спагетті? Знову?",
            "Спалювання Білого дому",
            "Спастичний ботанік",
            "Спільні голки",
            "Спільність у Христі",
            "Справжній людський зв’язок",
            "Справжня мексиканська кухня",
            "Ставлення",
            "Старий, який майже мертвий",
            "Статеве дозрівання",
            "Стати чорницею",
            "Стівен Гокінг говорить нечисті слова",
            "Стійкість об'єкта",
            "Стокгольмський синдром",
            "Страта заручника щогодини",
            "Страшний сон податкового інспектора",
            "Стримуючи хихикання при згадці про хуту і тутсі",
            "Стрілянина з автомобіля",
            "Стріляючи з гвинтівки в повітря, поки м’ячі глибоко у верещаючій кабані",
            "Судити всіх",
            "Суїцидальні думки",
            "Суки",
            "Сумна мастурбація",
            "Сумний бог із парою залитих лайном сосків",
            "Суперсолдати, створені за допомогою генної інженерії",
            "Сухе хвилювання",
            "Сучий ляпас",
            "Східноєвропейська турбо-фолк музика",
            "сьогодні всі штани наполовину знято",
            "Та штука, яка б'є твій прес електричним струмом",
            "Так розсердишся, що задеревишся",
            "Так розсердишся, що кинешся",
            "Татові веселі кульки",
            "Тверезий ірландець, якому байдужа картопля",
            "Твіти",
            "Темні та таємничі сили поза нашим контролем",
            "Тендітна мужність",
            "Термоядерна детонація",
            "Терористи",
            "Терти живіт Бориса Джонсона, поки він не засне",
            "Тертя",
            "Тисяча шотландських воїнів дружно піднімають кілти",
            "Тиша",
            "Тілесне світло",
            "Тільки знайомства з азіатськими жінками",
            "Товстий лисий чоловік з Інтернету",
            "Той один гей Телепузик",
            "Трахати мою сестру",
            "Тримати дитину й пукати на неї",
            "Тристороння розмова з моєю дружиною та Михайлом Поплавським",
            "Трохи використаний тампон",
            "Трохи ляпаса і лоскоту",
            "Трохи мочиться",
            "Трохи тонального крему, туші та трохи рум'ян",
            "Трусіть дитину, поки вона не перестане плакати",
            "У міма стався інсульт",
            "Удари депутата в обличчя",
            "Удари конгресмена в обличчя",
            "Укорінена класова система",
            "Улюблена бургерна Джастіна Бібера",
            "Улюблені затискачі для сосків Хілларі Клінтон",
            "Умпа-Лумпа",
            "Усі чуваки, яких я трахкав",
            "Утримання",
            "Фальшиві сиськи",
            "Фантазії лісоруба",
            "Фейсбук",
            "Х*бати синоптика в прямому ефірі",
            "Хаггіс",
            "Харизма",
            "Хвилина мовчання",
            "Хвилини спадщини",
            "Хворий вомбат",
            "Хвороба раптового вибуху калу",
            "Хвороблива дитина-король",
            "Хворобливе вигорання",
            "Хімічна зброя",
            "Хіпстери",
            "Хлопці з пухирчастими задниками",
            "Хлопці, які не дзвонять",
            "Хлопці",
            "Ходити і нюхати людям пахви",
            "Хороша, сильна горила",
            "Хороший нюх",
            "Хоспісна допомога",
            "Хуй-пальці",
            "Це життя смутку",
            "Циганське прокляття",
            "Ціла штука масла",
            "Цілую бабусю в лоб і вимикаю її систему життєзабезпечення",
            "Цілую неньку в лоб і вимикаю її систему життєзабезпечення",
            "Цуценята!",
            "Ця незграбна сім’я, яка думає, що сьогодні \"кіберсекс-понеділок\"",
            "Час желе з арахісовим маслом",
            "Червоні очі",
            "Черга",
            "Черепаха, що тріскається, кусає кінчик вашого пеніса",
            "Чесний вихід",
            "Чесний поліцейський, якому нічого втрачати",
            "Чечітка, наче завтра не буде",
            "Чоловік на межі оргазму",
            "Чоловік середніх років на роликових ковзанах",
            "Чоловіки обговорюють свої почуття емоційно здоровим способом",
            "Чоловіки",
            "Чорні люди",
            "Чортова тонна мигдалю",
            "Шахрайство на Спеціальній Олімпіаді",
            "Швидкий хук в обличчя",
            "Шикарний дроч",
            "Шматки мертвого автостопа",
            "Шматки мертвого туриста",
            "Шматки мертвої повії",
            "Шмірлер кучерявий",
            "Штурмовики",
            "Ще один проклятий фільм про вампірів",
            "Щипці",
            "Щуки",
            "Я дружу з твоїм татом у Facebook",
            "Я зараз роблю Кегеля",
            "Яйця птеродактиля",
            "Як далеко я можу затягнути власний пеніс у свою сідницю",
            "Як погано моя донька зіпсувала свій танцювальний концерт",
            "Як чудово бути білим",
            "Як чудово бути на грибах",
            "Якась людина-птах",
            "Якийсь клятий спокій і тиша",
            "Якийсь придурок кричить \"Ще дзвіночок\"",
            "Якийсь проклятий спокій і тиша",
            "Якийсь хлопець-панк, який вкрав мій сендвіч з індичкою",
            "Якийсь хлопець",
            "Японська китобійна операція",
            "Японський турист, який чогось дуже сильно хоче, але не може це повідомити",
        ).mapIndexed { index, words ->
            AnswerCardDTO(
                id = index.toString(),
                answer = words
            )
        }.sortedBy { Random.nextInt() }
    }

    override fun getRoomByIdFlow(roomID: RoomID): Flow<GameRoomDTO> {
        return roomsDbReference.child(roomID)
            .valueEvents
            .map {
                it.value()
            }
    }

    override suspend fun getRoomIfExist(roomID: RoomID): GameRoomDTO? {
        return kotlin.runCatching {
            roomsDbReference.roomOrException(roomID)
        }.getOrNull()
    }

    override suspend fun joinRoom(
        inviteCode: String,
        nickname: String
    ): PlayerDTO {
        roomsDbReference.roomOrException(inviteCode)
        return addPlayerToRoom(nickname, inviteCode, false)
    }

    private suspend fun addPlayerToRoom(
        nickname: String,
        roomId: RoomID,
        gameOwner: Boolean
    ): PlayerDTO {
        return roomsDbReference.child(roomId).child(DB_REF_PLAYERS).push().let { dbRef ->
            val uuid = dbRef.key ?: throw FailedToJoinRoomException(nickname, roomId)
            val newPlayer = PlayerDTO(
                id = uuid,
                nickname = nickname,
                gameOwner = if (gameOwner) 1 else 0,
                cards = emptyList(),
                score = 0,
                state = Player.PlayerState.NOT_READY.toString(),
            )
            dbRef.setValue(newPlayer)
            Napier.d(
                tag = TAG,
                message = "Player $nickname added to room $roomId"
            )
            newPlayer
        }
    }

    override suspend fun startNextRound(roomID: RoomID) {
        roomsDbReference.roomOrException(roomID) {
            val preUpdatedPlayers = savePlayersScores(it)
            refreshPlayers(it, preUpdatedPlayers)
            startNextRoundInRoom(it)
        }
    }

    private fun savePlayersScores(gameRoom: GameRoomDTO): List<PlayerDTO> {
        val gameRoomPlayersList = gameRoom.players.values.toList()
        val currentRound = gameRoom.currentRound ?: return gameRoomPlayersList
        val updatedPlayers = gameRoomPlayersList.map { player ->
            val playerRoundScore = currentRound.answers.firstOrNull {
                it.playerID == player.id
            }?.totalScore ?: return@map player
            player.copy(score = player.score + playerRoundScore)
        }
        Napier.d(
            tag = TAG,
            message = "Players scores in round ${currentRound.number} in room ${gameRoom.id} saved: ${updatedPlayers.joinToString { "${it.nickname} - ${it.score} points" }}"
        )
        return updatedPlayers
    }

    private suspend fun refreshPlayers(
        gameRoom: GameRoomDTO,
        preUpdatedPlayers: List<PlayerDTO>
    ) {
        val deckAnswers = gameRoom.answers.toMutableList()

        val updatedPlayers = preUpdatedPlayers.map { player ->
            val updatedPlayerCards = player.cards.toMutableList()
            val newCardsRequired = DEFAULT_PLAYER_CARDS_AMOUNT - updatedPlayerCards.size
            repeat(newCardsRequired) {
                val newCard = deckAnswers.filter { it.used == 0L }.random()
                updatedPlayerCards.add(newCard)
                val index = deckAnswers.indexOfFirst { it.id == newCard.id }
                deckAnswers[index] = deckAnswers[index].copy(used = 1L)
            }
            player.copy(
                cards = updatedPlayerCards,
                state = Player.PlayerState.ANSWERING.name
            )
        }.associateBy { it.id }

        roomsDbReference.child(gameRoom.id).updateChildren(
            mapOf(
                DB_REF_PLAYERS to updatedPlayers,
                DB_REF_ANSWERS to deckAnswers
            )
        )
        Napier.d(
            tag = TAG,
            message = "Cards in room ${gameRoom.id} updated"
        )
    }

    private suspend fun startNextRoundInRoom(gameRoom: GameRoomDTO) {
        val nextRoundNumber = gameRoom.currentRound?.number?.plus(1) ?: 1
        val nextQuestion = gameRoom.questions.getOrNull(nextRoundNumber - 1)?.id
        if (nextQuestion == null) {
            finishRoom(gameRoom)
            return
        }
        val nextRound = GameRoundDTO(
            id = nextRoundNumber.toString(),
            number = nextRoundNumber,
            question = nextQuestion,
            answers = emptyList(),
            state = "ACTIVE"
        )
        roomsDbReference.child(gameRoom.id)
            .child(DB_REF_CURRENT_ROUND)
            .setValue(nextRound)
        Napier.d(
            tag = TAG,
            message = "Room ${gameRoom.id} current round changed to $nextRound"
        )
    }

    private suspend fun finishRoom(gameRoom: GameRoomDTO) {
        roomsDbReference.child(gameRoom.id)
            .child(DB_REF_CURRENT_ROUND)
            .removeValue()
        Napier.d(
            tag = TAG,
            message = "Room ${gameRoom.id} finished"
        )
    }

    companion object {
        private val TAG = RoomsRepository::class.simpleName
    }
}